<!DOCTYPE html>
<html>
<head>
  <title>Store Locator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial;
      display: flex;
      height: 100vh;
      overflow: hidden;
      width: 100%;
    }

    #sidebar {
      width: 300px;
      background: #f4f4f4;
      padding: 10px 30px 10px 10px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      overflow-y: auto;
    }

    #map {
      flex: 1;
    }

    #searchInput, #storeSelect {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .store-item {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }

    .store-item:hover {
      background-color: #e2e2e2;
    }

    h2 {
      margin-top: 0;
    }
    #storeSelect {
        display: none;      /* Hide dropdown */
      }

    /* --- Responsive CSS --- */
    @media (max-width: 768px) {
      body {
        display: flex;
        flex-direction: column; /* stack sidebar on top */
        height: 100vh;
        margin: 0;
      }

      #sidebar {
        width: 100%;
        max-height: 40vh;  /* Sidebar takes up part of screen */
        overflow-y: auto;  /* Make sidebar scrollable */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }

      #map {
        flex: 1;            /* Map fills rest */
        min-height: 60vh;   /* Ensure height */
      }

      #searchInput,
      #storeList {
        display: block;     /* Keep search + list visible */
      }

      #storeSelect {
        display: none;      /* Hide dropdown */
      }
    }

    @media (max-width: 480px) {
      #sidebar {
        padding: 8px;
      }
      #searchInput, #storeSelect {
        font-size: 14px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <h2>Store Locator</h2>
    <input type="text" id="searchInput" placeholder="Search store name, city, or address...">
    <select id="storeSelect">
        <option value="">Select a Store</option>
    </select>
    <div id="storeList"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- init map ---
    const map = L.map('map').setView([23.185884, 79.974380], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // --- storage structures ---
    let allMarkers = [];          // array of markers (in CSV iteration order)
    const markerMap = new Map();  // Map(csvIndex -> marker) => robust lookup
    let storeData = [];          // array of store objects (with original CSV index)

    // small helper to escape HTML for popup text (avoid accidental HTML injection)
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function addMarker(name, address, city, lat, lng, index, contact) {
      const marker = L.marker([lat, lng]).addTo(map);
      const popupHtml = `<strong>${escapeHtml(name)}</strong><br>${escapeHtml(address)}<br>${escapeHtml(contact)}`;
      marker.bindPopup(popupHtml);
      // meta stored on marker for quick searching/filtering
      marker.meta = { name, address, city, index, contact, lat, lng };
      allMarkers.push(marker);
      markerMap.set(index, marker); // IMPORTANT: reliable mapping from CSV index -> marker
      return marker;
    }

    function updateStoreList(filteredStores) {
      const listEl = document.getElementById('storeList');
      listEl.innerHTML = "";

      if (filteredStores.length === 0) {
        listEl.innerHTML = "<p>No matching stores found.</p>";
        return;
      }

      filteredStores.forEach(store => {
        const div = document.createElement("div");
        div.className = "store-item";
        div.textContent = `${toTitleCase(store.name)} (${toTitleCase(store.city)}), Contact - ${store.contact}`;
        div.addEventListener("click", () => {
          // lookup marker reliably by original CSV index via markerMap
          const marker = markerMap.get(store.index);
          if (marker) {
            map.invalidateSize();
            map.setView(marker.getLatLng(), 14);
            marker.openPopup();
            // adjust so popup isn’t hidden under the UI
            if (window.innerWidth > 768) {
              map.panBy([120, 0], { animate: true });
            } else {
              map.panBy([0, -120], { animate: true });
            }
          } else {
            // debug fallback (shouldn't happen) — uncomment to debug
            // console.warn('Marker not found for index', store.index);
          }
        });
        listEl.appendChild(div);
      });
    }

    function populateStoreDropdown(stores) {
      const selectEl = document.getElementById('storeSelect');
      selectEl.innerHTML = '<option value="">Select a Store</option>';

      // Use original CSV index as option.value so we can map to markerMap
      stores.forEach((store) => {
        const option = document.createElement('option');
        option.value = store.index;
        option.textContent = `${toTitleCase(store.name)} (${toTitleCase(store.city)})`;
        selectEl.appendChild(option);
      });
    }

    function filterStores(query) {
      const lowerQuery = String(query || '').toLowerCase();
      let filteredStores = [];

      // iterate marker list and test each marker.meta for a match
      allMarkers.forEach(marker => {
        const store = marker.meta;
        const match = store.name.toLowerCase().includes(lowerQuery) ||
                      store.address.toLowerCase().includes(lowerQuery) ||
                      store.city.toLowerCase().includes(lowerQuery);

        if (match) {
          if (!map.hasLayer(marker)) marker.addTo(map);
          filteredStores.push(store);
        } else {
          if (map.hasLayer(marker)) map.removeLayer(marker);
        }
      });

      // sort by name for neat list display (store.index stays original CSV index)
      filteredStores.sort((a, b) => a.name.localeCompare(b.name));
      updateStoreList(filteredStores);

      // Fit to visible markers (if any)
      const visibleMarkers = allMarkers.filter(marker => map.hasLayer(marker));
      if (visibleMarkers.length > 0) {
        const group = L.featureGroup(visibleMarkers);
        map.fitBounds(group.getBounds().pad(0.2));
      } else {
        map.setView([23.185884, 79.974380], 6);
      }
    }

    // search input
    document.getElementById('searchInput').addEventListener('input', e => {
      filterStores(e.target.value);
    });

    // dropdown selection (if visible)
    document.getElementById('storeSelect').addEventListener('change', e => {
      const originalIndex = parseInt(e.target.value, 10);
      if (!isNaN(originalIndex)) {
        const marker = markerMap.get(originalIndex);
        if (marker) {
          map.invalidateSize();
          map.flyTo(marker.getLatLng(), 16, { animate: true, duration: 1.2 });
          marker.openPopup();
          if (window.innerWidth > 768) {
            map.panBy([120, 0], { animate: true });
          } else {
            map.panBy([0, -120], { animate: true });
          }
        } else {
          // console.warn('No marker for index', originalIndex);
        }
      }
    });

    // --- Load CSV and create markers ---
    fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vQhIU7lqfi5iHWY1kDwo57TyyHMEKa0tWctb2Hz1clBIlWzMaw3qJLuJ_AjBRHrb4ev2iS4P0FwhT2x/pub?output=csv")
      .then(res => res.text())
      .then(csv => {
        const data = Papa.parse(csv, { header: true }).data;

        data.forEach((row, csvIndex) => {
          // adapt to whichever columns you have
          const name = row['Store Name'] || row['Name'] || row[0] || '';
          const address = row['Address'] || row[1] || '';
          const city = row['City'] || row[2] || '';
          const lat = parseFloat(row['Latitude'] || row[3]);
          const lng = parseFloat(row['Longitude'] || row[4]);
          const contact = row['Contact'] || row[5] || '';

          if (!isNaN(lat) && !isNaN(lng)) {
            // 1) add marker (map & internal structures)
            addMarker(name, address, city, lat, lng, csvIndex, contact);

            // 2) store data for lists/dropdown (index is original CSV index)
            storeData.push({ name, address, city, lat, lng, index: csvIndex, contact });
          }
        });

        // sort the displayed list alphabetically (store.index still points to original CSV row)
        storeData.sort((a, b) => a.name.localeCompare(b.name));

        populateStoreDropdown(storeData);
        updateStoreList(storeData);
        // ensure Leaflet recalculates tile sizes
        setTimeout(() => map.invalidateSize(), 300);
      })
      .catch(err => {
        console.error('Failed to load CSV', err);
      });

    function toTitleCase(str) {
      if (!str) return '';
      return str
        .toLowerCase()
        .split(/[\s-_]+/)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    // keep map rendered correctly on resize
    window.addEventListener("resize", () => {
      map.invalidateSize();
    });
  </script>
</body>
</html>
